name: Branch Scripts and Artifacts

on:
  workflow_dispatch:
    inputs:
      platform:
        description: "Target platform for Rive build"
        required: true
        type: choice
        options: ["x86_64-linux", "arm64-macos", "x86_64-macos", "arm64-ios", "x86_64-ios", "arm64-android", "armv7-android", "js-web", "wasm-web", "wasm_pthread-web", "all"]
        default: "x86_64-linux"
      rive_repo_url:
        description: "Rive runtime repo URL (HTTPS)"
        required: true
        default: "https://github.com/rive-app/rive-runtime.git"
      rive_ref:
        description: "Rive runtime ref (branch/tag/commit). Leave empty for default."
        required: false
        default: ""
      rive_sha:
        description: "Rive runtime commit SHA to checkout (overrides rive_ref)"
        required: false
        default: ""
      upload_artifact:
        description: "Upload tarball artifact (defold-rive/lib + include)"
        required: true
        type: choice
        options: ["true", "false"]
        default: "false"
      commit_message:
        description: "Optional commit message suffix"
        required: false
        default: ""
      push_changes:
        description: "Push changes back to the same branch"
        required: true
        type: choice
        options: ["true", "false"]
        default: "true"

permissions:
  contents: write

concurrency:
  group: branch-artifacts-${{ github.ref_name }}
  cancel-in-progress: false

jobs:
  build-linux:
    if: ${{ github.event.inputs.platform == 'x86_64-linux' || github.event.inputs.platform == 'all' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Linux build dependencies (uuid, X11, Xcursor, Xrandr, Xi, Xinerama, Xf86VidMode)
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y uuid-dev libx11-dev libxcursor-dev libxrandr-dev libxi-dev libxinerama-dev libxxf86vm-dev

      - name: Clone Rive runtime and set RIVE_ROOT
        shell: bash
        run: |
          set -euo pipefail
          RIVE_TMP_DIR=$(mktemp -d)
          echo "RIVE_ROOT=${RIVE_TMP_DIR}" >> "$GITHUB_ENV"
          url="${{ github.event.inputs.rive_repo_url }}"
          ref="${{ github.event.inputs.rive_ref }}"
          sha="${{ github.event.inputs.rive_sha }}"
          echo "Cloning Rive runtime from: ${url}"
          if [ -n "$sha" ]; then
            git clone --depth 1 "$url" "$RIVE_TMP_DIR"
            (cd "$RIVE_TMP_DIR" && git fetch --depth 1 origin "$sha" && git checkout -f "$sha")
          elif [ -n "$ref" ]; then
            git clone --depth 1 --branch "$ref" "$url" "$RIVE_TMP_DIR"
          else
            git clone --depth 1 "$url" "$RIVE_TMP_DIR"
          fi
          echo "RIVE_ROOT set to: $RIVE_TMP_DIR"

      - name: Ensure clean Rive repo
        shell: bash
        run: |
          set -euo pipefail
          if [ -d "${RIVE_ROOT}/.git" ]; then
            cd "${RIVE_ROOT}"
            if [ -n "$(git status --porcelain)" ]; then
              echo "Pending changes detected; resetting Rive repo"
              git reset --hard
            else
              echo "Rive repo is clean"
            fi
          fi

      - name: Show context
        shell: bash
        run: |
          echo "Branch: ${{ github.ref_name }}"
          echo "RIVE_ROOT: ${RIVE_ROOT:-not-set}"
          echo "Platform: ${{ github.event.inputs.platform }}"
          git --version
          git status

      - name: Build Rive runtime
        shell: bash
        run: |
          set -euo pipefail
          platform="x86_64-linux"
          echo "Running: ./utils/build_rive_runtime.sh ${platform} ${RIVE_ROOT}"
          bash utils/build_rive_runtime.sh "${platform}" "${RIVE_ROOT}"

      - name: Pack artifacts (optional)
        if: ${{ github.event.inputs.upload_artifact == 'true' }}
        shell: bash
        run: |
          set -euo pipefail
          paths=()
          [ -d defold-rive/lib ] && paths+=(defold-rive/lib)
          [ -d defold-rive/include ] && paths+=(defold-rive/include)
          if [ ${#paths[@]} -eq 0 ]; then
            echo "No artifact directories found (defold-rive/lib, defold-rive/include)."
            exit 0
          fi
          echo "Packing: ${paths[*]}"
          tar -czf "branch-artifacts-${{ github.ref_name }}.tgz" "${paths[@]}"

      - name: Upload artifact (optional)
        if: ${{ github.event.inputs.upload_artifact == 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: branch-artifacts-${{ github.ref_name }}
          path: branch-artifacts-${{ github.ref_name }}.tgz
          if-no-files-found: ignore

      - name: Commit and push changes (optional)
        if: ${{ github.event.inputs.push_changes == 'true' }}
        shell: bash
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          add_paths=()
          [ -d defold-rive/lib ] && add_paths+=(defold-rive/lib)
          [ -d defold-rive/include ] && add_paths+=(defold-rive/include)
          if [ ${#add_paths[@]} -gt 0 ]; then
            git add -v "${add_paths[@]}" || true
          fi
          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi
          msg="ci: update artifacts on ${{ github.ref_name }} [skip ci]"
          if [ -n "${{ github.event.inputs.commit_message }}" ]; then
            msg="$msg - ${{ github.event.inputs.commit_message }}"
          fi
          git commit -m "$msg"
          max_attempts=3
          attempt=1
          until [ $attempt -gt $max_attempts ]; do
            echo "Attempt $attempt: rebase + push"
            if git pull --rebase origin "${{ github.ref_name }}"; then
              if git push origin HEAD:"${{ github.ref_name }}"; then
                echo "Push succeeded"
                break
              fi
            else
              echo "Rebase failed; aborting and retrying"
              git rebase --abort || true
            fi
            attempt=$((attempt+1))
            sleep $((attempt*2))
          done
          if [ $attempt -gt $max_attempts ]; then
            echo "Push failed after $max_attempts attempts"
            exit 1
          fi

      - name: Post-commit status
        if: ${{ always() }}
        shell: bash
        run: |
          git --no-pager log -1 --oneline || true
          git status || true

  build-macos:
    if: ${{ github.event.inputs.platform == 'arm64-macos' || github.event.inputs.platform == 'x86_64-macos' || github.event.inputs.platform == 'arm64-ios' || github.event.inputs.platform == 'x86_64-ios' || github.event.inputs.platform == 'all' }}
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Clone Rive runtime and set RIVE_ROOT
        shell: bash
        run: |
          set -euo pipefail
          RIVE_TMP_DIR=$(mktemp -d)
          echo "RIVE_ROOT=${RIVE_TMP_DIR}" >> "$GITHUB_ENV"
          url="${{ github.event.inputs.rive_repo_url }}"
          ref="${{ github.event.inputs.rive_ref }}"
          sha="${{ github.event.inputs.rive_sha }}"
          echo "Cloning Rive runtime from: ${url}"
          if [ -n "$sha" ]; then
            git clone --depth 1 "$url" "$RIVE_TMP_DIR"
            (cd "$RIVE_TMP_DIR" && git fetch --depth 1 origin "$sha" && git checkout -f "$sha")
          elif [ -n "$ref" ]; then
            git clone --depth 1 --branch "$ref" "$url" "$RIVE_TMP_DIR"
          else
            git clone --depth 1 "$url" "$RIVE_TMP_DIR"
          fi
          echo "RIVE_ROOT set to: $RIVE_TMP_DIR"

      - name: Ensure clean Rive repo
        shell: bash
        run: |
          set -euo pipefail
          if [ -d "${RIVE_ROOT}/.git" ]; then
            cd "${RIVE_ROOT}"
            if [ -n "$(git status --porcelain)" ]; then
              echo "Pending changes detected; resetting Rive repo"
              git reset --hard
            else
              echo "Rive repo is clean"
            fi
          fi

      - name: Show context
        shell: bash
        run: |
          echo "Branch: ${{ github.ref_name }}"
          echo "RIVE_ROOT: ${RIVE_ROOT:-not-set}"
          echo "Platform: ${{ github.event.inputs.platform }}"
          git --version
          git status

      - name: Build Rive runtime
        shell: bash
        run: |
          set -euo pipefail
          input_platform="${{ github.event.inputs.platform }}"
          build_one() {
            local platform="$1"
            echo "Running: ./utils/build_rive_runtime.sh ${platform} ${RIVE_ROOT}"
            bash utils/build_rive_runtime.sh "${platform}" "${RIVE_ROOT}"
          }
          if [ "$input_platform" = "all" ]; then
            for p in arm64-macos x86_64-macos arm64-ios x86_64-ios; do
              build_one "$p"
            done
          else
            build_one "$input_platform"
          fi

      - name: Pack artifacts (optional)
        if: ${{ github.event.inputs.upload_artifact == 'true' }}
        shell: bash
        run: |
          set -euo pipefail
          paths=()
          [ -d defold-rive/lib ] && paths+=(defold-rive/lib)
          [ -d defold-rive/include ] && paths+=(defold-rive/include)
          if [ ${#paths[@]} -eq 0 ]; then
            echo "No artifact directories found (defold-rive/lib, defold-rive/include)."
            exit 0
          fi
          echo "Packing: ${paths[*]}"
          tar -czf "branch-artifacts-${{ github.ref_name }}.tgz" "${paths[@]}"

      - name: Upload artifact (optional)
        if: ${{ github.event.inputs.upload_artifact == 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: branch-artifacts-${{ github.ref_name }}
          path: branch-artifacts-${{ github.ref_name }}.tgz
          if-no-files-found: ignore

      - name: Commit and push changes (optional)
        if: ${{ github.event.inputs.push_changes == 'true' }}
        shell: bash
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          add_paths=()
          [ -d defold-rive/lib ] && add_paths+=(defold-rive/lib)
          [ -d defold-rive/include ] && add_paths+=(defold-rive/include)
          if [ ${#add_paths[@]} -gt 0 ]; then
            git add -v "${add_paths[@]}" || true
          fi
          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi
          msg="ci: update artifacts on ${{ github.ref_name }} [skip ci]"
          if [ -n "${{ github.event.inputs.commit_message }}" ]; then
            msg="$msg - ${{ github.event.inputs.commit_message }}"
          fi
          git commit -m "$msg"
          max_attempts=3
          attempt=1
          until [ $attempt -gt $max_attempts ]; do
            echo "Attempt $attempt: rebase + push"
            if git pull --rebase origin "${{ github.ref_name }}"; then
              if git push origin HEAD:"${{ github.ref_name }}"; then
                echo "Push succeeded"
                break
              fi
            else
              echo "Rebase failed; aborting and retrying"
              git rebase --abort || true
            fi
            attempt=$((attempt+1))
            sleep $((attempt*2))
          done
          if [ $attempt -gt $max_attempts ]; then
            echo "Push failed after $max_attempts attempts"
            exit 1
          fi

      - name: Post-commit status
        if: ${{ always() }}
        shell: bash
        run: |
          git --no-pager log -1 --oneline || true
          git status || true

  build-android:
    if: ${{ github.event.inputs.platform == 'arm64-android' || github.event.inputs.platform == 'armv7-android' || github.event.inputs.platform == 'all' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Linux dependencies (uuid for premake)
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y uuid-dev

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Set up Premake5
        uses: abdes/setup-premake@v1
        with:
          version: "5.0.0-beta2"

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: Set up Android NDK r25c (25.2.9519653)
        id: setup-ndk
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r25c
      - name: Export ANDROID_NDK env
        shell: bash
        run: |
          echo "ANDROID_NDK=${{ steps.setup-ndk.outputs.ndk-path }}" >> "$GITHUB_ENV"
          echo "Using ANDROID_NDK=${{ steps.setup-ndk.outputs.ndk-path }}"

      - name: Configure Android toolchain environment
        shell: bash
        run: |
          set -euo pipefail
          echo "ANDROID_NDK_HOME=${ANDROID_NDK}" >> "$GITHUB_ENV"
          echo "NDK_PATH=${ANDROID_NDK}" >> "$GITHUB_ENV"
          # API 21 is a safe default for arm64 and armv7 toolchains
          echo "ANDROID_API=21" >> "$GITHUB_ENV"

      - name: Clone Rive runtime and set RIVE_ROOT
        shell: bash
        run: |
          set -euo pipefail
          RIVE_TMP_DIR=$(mktemp -d)
          echo "RIVE_ROOT=${RIVE_TMP_DIR}" >> "$GITHUB_ENV"
          url="${{ github.event.inputs.rive_repo_url }}"
          ref="${{ github.event.inputs.rive_ref }}"
          sha="${{ github.event.inputs.rive_sha }}"
          echo "Cloning Rive runtime from: ${url}"
          if [ -n "$sha" ]; then
            git clone --depth 1 "$url" "$RIVE_TMP_DIR"
            (cd "$RIVE_TMP_DIR" && git fetch --depth 1 origin "$sha" && git checkout -f "$sha")
          elif [ -n "$ref" ]; then
            git clone --depth 1 --branch "$ref" "$url" "$RIVE_TMP_DIR"
          else
            git clone --depth 1 "$url" "$RIVE_TMP_DIR"
          fi
          echo "RIVE_ROOT set to: $RIVE_TMP_DIR"

      - name: Ensure clean Rive repo
        shell: bash
        run: |
          set -euo pipefail
          if [ -d "${RIVE_ROOT}/.git" ]; then
            cd "${RIVE_ROOT}"
            if [ -n "$(git status --porcelain)" ]; then
              echo "Pending changes detected; resetting Rive repo"
              git reset --hard
            else
              echo "Rive repo is clean"
            fi
          fi

      - name: Show context
        shell: bash
        run: |
          echo "Branch: ${{ github.ref_name }}"
          echo "RIVE_ROOT: ${RIVE_ROOT:-not-set}"
          echo "Platform: ${{ github.event.inputs.platform }}"
          echo "ANDROID_SDK_ROOT: ${ANDROID_SDK_ROOT:-not-set}"
          echo "ANDROID_NDK: ${ANDROID_NDK:-not-set}"
          git --version
          git status

      - name: Build Rive runtime
        shell: bash
        run: |
          set -euo pipefail
          ndk_bin="${ANDROID_NDK}/toolchains/llvm/prebuilt/linux-x86_64/bin"
          export ANDROID_API="${ANDROID_API:-21}"
          build_one() {
            local platform="$1"
            local cc=""
            local cxx=""
            case "$platform" in
              arm64-android)
                cc="${ndk_bin}/aarch64-linux-android${ANDROID_API}-clang"
                cxx="${ndk_bin}/aarch64-linux-android${ANDROID_API}-clang++"
                ;;
              armv7-android)
                # For armv7 use 19+; 21 is fine for modern NDKs
                cc="${ndk_bin}/armv7a-linux-androideabi${ANDROID_API}-clang"
                cxx="${ndk_bin}/armv7a-linux-androideabi${ANDROID_API}-clang++"
                ;;
              *)
                echo "Unknown android platform: $platform" >&2; return 1 ;;
            esac
            echo "Using CC=$cc"
            echo "Using CXX=$cxx"
            CC="$cc" CXX="$cxx" bash utils/build_rive_runtime.sh "$platform" "$RIVE_ROOT"
          }

          input_platform="${{ github.event.inputs.platform }}"
          if [ "$input_platform" = "all" ]; then
            for platform in arm64-android armv7-android; do
              echo "Running: ./utils/build_rive_runtime.sh ${platform} ${RIVE_ROOT}"
              build_one "$platform"
            done
          else
            echo "Running: ./utils/build_rive_runtime.sh ${input_platform} ${RIVE_ROOT}"
            build_one "$input_platform"
          fi

      - name: Pack artifacts (optional)
        if: ${{ github.event.inputs.upload_artifact == 'true' }}
        shell: bash
        run: |
          set -euo pipefail
          paths=()
          [ -d defold-rive/lib ] && paths+=(defold-rive/lib)
          [ -d defold-rive/include ] && paths+=(defold-rive/include)
          if [ ${#paths[@]} -eq 0 ]; then
            echo "No artifact directories found (defold-rive/lib, defold-rive/include)."
            exit 0
          fi
          echo "Packing: ${paths[*]}"
          tar -czf "branch-artifacts-${{ github.ref_name }}.tgz" "${paths[@]}"

      - name: Upload artifact (optional)
        if: ${{ github.event.inputs.upload_artifact == 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: branch-artifacts-${{ github.ref_name }}
          path: branch-artifacts-${{ github.ref_name }}.tgz
          if-no-files-found: ignore

      - name: Commit and push changes (optional)
        if: ${{ github.event.inputs.push_changes == 'true' }}
        shell: bash
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          add_paths=()
          [ -d defold-rive/lib ] && add_paths+=(defold-rive/lib)
          [ -d defold-rive/include ] && add_paths+=(defold-rive/include)
          if [ ${#add_paths[@]} -gt 0 ]; then
            git add -v "${add_paths[@]}" || true
          fi
          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi
          msg="ci: update artifacts on ${{ github.ref_name }} [skip ci]"
          if [ -n "${{ github.event.inputs.commit_message }}" ]; then
            msg="$msg - ${{ github.event.inputs.commit_message }}"
          fi
          git commit -m "$msg"
          max_attempts=3
          attempt=1
          until [ $attempt -gt $max_attempts ]; do
            echo "Attempt $attempt: rebase + push"
            if git pull --rebase origin "${{ github.ref_name }}"; then
              if git push origin HEAD:"${{ github.ref_name }}"; then
                echo "Push succeeded"
                break
              fi
            else
              echo "Rebase failed; aborting and retrying"
              git rebase --abort || true
            fi
            attempt=$((attempt+1))
            sleep $((attempt*2))
          done
          if [ $attempt -gt $max_attempts ]; then
            echo "Push failed after $max_attempts attempts"
            exit 1
          fi

      - name: Post-commit status
        if: ${{ always() }}
        shell: bash
        run: |
          git --no-pager log -1 --oneline || true
          git status || true
  build-web:
    if: ${{ github.event.inputs.platform == 'js-web' || github.event.inputs.platform == 'wasm-web' || github.event.inputs.platform == 'wasm_pthread-web' || github.event.inputs.platform == 'all' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Linux dependencies (uuid for premake)
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y uuid-dev

      - name: Clone Rive runtime and set RIVE_ROOT
        shell: bash
        run: |
          set -euo pipefail
          RIVE_TMP_DIR=$(mktemp -d)
          echo "RIVE_ROOT=${RIVE_TMP_DIR}" >> "$GITHUB_ENV"
          url="${{ github.event.inputs.rive_repo_url }}"
          ref="${{ github.event.inputs.rive_ref }}"
          sha="${{ github.event.inputs.rive_sha }}"
          echo "Cloning Rive runtime from: ${url}"
          if [ -n "$sha" ]; then
            git clone --depth 1 "$url" "$RIVE_TMP_DIR"
            (cd "$RIVE_TMP_DIR" && git fetch --depth 1 origin "$sha" && git checkout -f "$sha")
          elif [ -n "$ref" ]; then
            git clone --depth 1 --branch "$ref" "$url" "$RIVE_TMP_DIR"
          else
            git clone --depth 1 "$url" "$RIVE_TMP_DIR"
          fi
          echo "RIVE_ROOT set to: $RIVE_TMP_DIR"

      - name: Ensure clean Rive repo
        shell: bash
        run: |
          set -euo pipefail
          if [ -d "${RIVE_ROOT}/.git" ]; then
            cd "${RIVE_ROOT}"
            if [ -n "$(git status --porcelain)" ]; then
              echo "Pending changes detected; resetting Rive repo"
              git reset --hard
            else
              echo "Rive repo is clean"
            fi
          fi

      - name: Show context
        shell: bash
        run: |
          echo "Branch: ${{ github.ref_name }}"
          echo "RIVE_ROOT: ${RIVE_ROOT:-not-set}"
          echo "Platform input: ${{ github.event.inputs.platform }}"
          git --version
          git status

      - name: Build Rive runtime (web)
        shell: bash
        run: |
          set -euo pipefail
          input_platform="${{ github.event.inputs.platform }}"
          build_one() {
            local platform="$1"
            echo "Running: ./utils/build_rive_runtime.sh ${platform} ${RIVE_ROOT}"
            bash utils/build_rive_runtime.sh "${platform}" "${RIVE_ROOT}"
          }
          if [ "$input_platform" = "all" ]; then
            for platform in js-web wasm-web wasm_pthread-web; do
              build_one "$platform"
            done
          else
            build_one "$input_platform"
          fi

      - name: Pack artifacts (optional)
        if: ${{ github.event.inputs.upload_artifact == 'true' }}
        shell: bash
        run: |
          set -euo pipefail
          paths=()
          [ -d defold-rive/lib ] && paths+=(defold-rive/lib)
          [ -d defold-rive/include ] && paths+=(defold-rive/include)
          if [ ${#paths[@]} -eq 0 ]; then
            echo "No artifact directories found (defold-rive/lib, defold-rive/include)."
            exit 0
          fi
          echo "Packing: ${paths[*]}"
          tar -czf "branch-artifacts-${{ github.ref_name }}.tgz" "${paths[@]}"

      - name: Upload artifact (optional)
        if: ${{ github.event.inputs.upload_artifact == 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: branch-artifacts-${{ github.ref_name }}
          path: branch-artifacts-${{ github.ref_name }}.tgz
          if-no-files-found: ignore

      - name: Commit and push changes (optional)
        if: ${{ github.event.inputs.push_changes == 'true' }}
        shell: bash
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          add_paths=()
          [ -d defold-rive/lib ] && add_paths+=(defold-rive/lib)
          [ -d defold-rive/include ] && add_paths+=(defold-rive/include)
          if [ ${#add_paths[@]} -gt 0 ]; then
            git add -v "${add_paths[@]}" || true
          fi
          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi
          msg="ci: update artifacts on ${{ github.ref_name }} [skip ci]"
          if [ -n "${{ github.event.inputs.commit_message }}" ]; then
            msg="$msg - ${{ github.event.inputs.commit_message }}"
          fi
          git commit -m "$msg"
          max_attempts=3
          attempt=1
          until [ $attempt -gt $max_attempts ]; do
            echo "Attempt $attempt: rebase + push"
            if git pull --rebase origin "${{ github.ref_name }}"; then
              if git push origin HEAD:"${{ github.ref_name }}"; then
                echo "Push succeeded"
                break
              fi
            else
              echo "Rebase failed; aborting and retrying"
              git rebase --abort || true
            fi
            attempt=$((attempt+1))
            sleep $((attempt*2))
          done
          if [ $attempt -gt $max_attempts ]; then
            echo "Push failed after $max_attempts attempts"
            exit 1
          fi

      - name: Post-commit status
        if: ${{ always() }}
        shell: bash
        run: |
          git --no-pager log -1 --oneline || true
          git status || true
